WITH src AS (
  SELECT
    EMPLOYEE_ID,
    REPORT_DATE,
    HR_EMPLOYEE_STATUS_DESC
  FROM TABLE
  WHERE REPORT_DATE >= '2025-10-01'
    AND REPORT_DATE <= '2025-10-31'
),

status_ranges AS (
  SELECT
    EMPLOYEE_ID,
    HR_EMPLOYEE_STATUS_CHANGE_COUNT,
    HR_EMPLOYEE_STATUS_START_DATE,
    HR_EMPLOYEE_STATUS_DESC,
    HR_EMPLOYEE_STATUS_END_DATE
  FROM (
    SELECT
      EMPLOYEE_ID,
      HR_EMPLOYEE_STATUS_DESC,
      REPORT_DATE,
      COUNT(DISTINCT HR_EMPLOYEE_STATUS_DESC)
        OVER (PARTITION BY EMPLOYEE_ID) AS HR_EMPLOYEE_STATUS_CHANGE_COUNT,

      MIN(REPORT_DATE) OVER (
        PARTITION BY EMPLOYEE_ID
      ) AS FIRST_SEEN_DATE,

      ROW_NUMBER() OVER (
        PARTITION BY EMPLOYEE_ID
        ORDER BY REPORT_DATE
      ) AS rn_all,

      ROW_NUMBER() OVER (
        PARTITION BY EMPLOYEE_ID, HR_EMPLOYEE_STATUS_DESC
        ORDER BY REPORT_DATE
      ) AS rn_status,

      -- group id for each continuous status run
      rn_all - rn_status AS grp
    FROM src
  )
  GROUP BY
    EMPLOYEE_ID,
    HR_EMPLOYEE_STATUS_CHANGE_COUNT,
    HR_EMPLOYEE_STATUS_DESC,
    grp,
    FIRST_SEEN_DATE
  QUALIFY
    TRUE
),

final AS (
  SELECT
    EMPLOYEE_ID,
    HR_EMPLOYEE_STATUS_CHANGE_COUNT,
    MIN(REPORT_DATE) AS HR_EMPLOYEE_STATUS_START_DATE,
    HR_EMPLOYEE_STATUS_DESC,
    MAX(REPORT_DATE) AS HR_EMPLOYEE_STATUS_END_DATE
  FROM (
    SELECT
      EMPLOYEE_ID,
      HR_EMPLOYEE_STATUS_DESC,
      REPORT_DATE,
      HR_EMPLOYEE_STATUS_CHANGE_COUNT,
      rn_all - rn_status AS grp
    FROM (
      SELECT
        EMPLOYEE_ID,
        HR_EMPLOYEE_STATUS_DESC,
        REPORT_DATE,
        COUNT(DISTINCT HR_EMPLOYEE_STATUS_DESC)
          OVER (PARTITION BY EMPLOYEE_ID) AS HR_EMPLOYEE_STATUS_CHANGE_COUNT,
        ROW_NUMBER() OVER (
          PARTITION BY EMPLOYEE_ID
          ORDER BY REPORT_DATE
        ) AS rn_all,
        ROW_NUMBER() OVER (
          PARTITION BY EMPLOYEE_ID, HR_EMPLOYEE_STATUS_DESC
          ORDER BY REPORT_DATE
        ) AS rn_status
      FROM src
    )
  )
  GROUP BY
    EMPLOYEE_ID,
    HR_EMPLOYEE_STATUS_CHANGE_COUNT,
    HR_EMPLOYEE_STATUS_DESC,
    grp
)

SELECT
  EMPLOYEE_ID,
  HR_EMPLOYEE_STATUS_CHANGE_COUNT,
  HR_EMPLOYEE_STATUS_START_DATE,
  HR_EMPLOYEE_STATUS_DESC,
  HR_EMPLOYEE_STATUS_END_DATE
FROM final
ORDER BY EMPLOYEE_ID, HR_EMPLOYEE_STATUS_START_DATE;
