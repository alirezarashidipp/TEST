WITH src AS (
  SELECT
    EMPLOYEE_ID,
    REPORT_DATE,
    HR_EMPLOYEE_STATUS_DESC
  FROM TABLE
  WHERE REPORT_DATE >= '2025-10-01'
    AND REPORT_DATE <= '2025-10-31'
),

changes AS (
  SELECT
    EMPLOYEE_ID,

    COUNT(DISTINCT HR_EMPLOYEE_STATUS_DESC)
      OVER (PARTITION BY EMPLOYEE_ID) AS STATUS_CHANGE_COUNT,

    FIRST_VALUE(HR_EMPLOYEE_STATUS_DESC)
      OVER (PARTITION BY EMPLOYEE_ID ORDER BY REPORT_DATE) AS CHANGE_FROM,

    FIRST_VALUE(REPORT_DATE)
      OVER (PARTITION BY EMPLOYEE_ID ORDER BY REPORT_DATE) AS CHANGE_FROM_REPORT_DATE,

    LAST_VALUE(HR_EMPLOYEE_STATUS_DESC)
      OVER (PARTITION BY EMPLOYEE_ID ORDER BY REPORT_DATE
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS CHANGE_TO,

    LAST_VALUE(REPORT_DATE)
      OVER (PARTITION BY EMPLOYEE_ID ORDER BY REPORT_DATE
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS CHANGE_TO_REPORT_DATE,

    ROW_NUMBER()
      OVER (PARTITION BY EMPLOYEE_ID ORDER BY REPORT_DATE DESC) AS RN

  FROM src
)

SELECT *
FROM changes
WHERE
  (STATUS_CHANGE_COUNT = 1 AND RN = 1)
  OR
  (STATUS_CHANGE_COUNT > 1)
ORDER BY EMPLOYEE_ID, REPORT_DATE;
